
{% extends "base.html" %}

{% block content %}

  <h2>Your Decks</h2>

  <div class="deck-list" id="decksContainer"></div>

  <!-- Create Deck Modal -->
  <div id="createDeckModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Create New Deck</h3>
      <div class="new-deck-section">
        <input type="text" id="newDeckName" class="form-input" placeholder="Enter deck name">
        <button id="createDeckBtn" class="form-button">Create Deck</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loggedIn = {{ logged_in | default(value=false) }};
      const currentUserId = {{ user_id | default(value="null") }};
      const decksContainer = document.getElementById('decksContainer');
      
      // Modal elements
      const createDeckModal = document.getElementById('createDeckModal');
      const newDeckNameInput = document.getElementById('newDeckName');
      const createDeckBtn = document.getElementById('createDeckBtn');
      const modalClose = document.querySelector('#createDeckModal .close');
      
      if (!loggedIn || !currentUserId) {
        decksContainer.innerHTML = `
          <div class="result-item">
            <p>Please <a href="/auth/login">log in</a> to view your decks.</p>
          </div>
        `;
        return;
      }

      // Show create deck modal
      function showCreateDeckModal() {
        newDeckNameInput.value = '';
        createDeckModal.style.display = 'block';
      }

      // Close modal
      function closeModal() {
        createDeckModal.style.display = 'none';
      }

      // Modal event listeners
      modalClose.addEventListener('click', closeModal);
      window.addEventListener('click', function(event) {
        if (event.target === createDeckModal) {
          closeModal();
        }
      });

      // Create deck button handler
      createDeckBtn.addEventListener('click', async function() {
        const deckName = newDeckNameInput.value.trim();
        if (!deckName) {
          alert('Please enter a deck name');
          return;
        }

        try {
          const response = await fetch('/api/decks/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              name: deckName,
              word_data: null // No word to add
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create deck');
          }

          const data = await response.json();
          if (data.success) {
            alert('Deck created successfully!');
            closeModal();
            // Refresh the deck list
            fetchDecks();
          } else {
            throw new Error(data.message || 'Unknown error creating deck');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error creating deck: ' + error.message);
        }
      });

      // Function to fetch and display decks
      function fetchDecks() {
        fetch('/api/decks')
          .then(response => {
            if (!response.ok) {
              throw new Error(response.status === 401 
                ? 'Session expired. Please log in again.' 
                : 'Failed to fetch decks');
            }
            return response.json();
          })
          .then(decks => {
            if (decks.length === 0) {
              decksContainer.innerHTML = `
                <div class="result-item">
                  <p>You have no decks yet.</p>
                  <button id="createFirstDeckBtn" class="view-deck-btn">
                    Create Your First Deck
                  </button>
                </div>
              `;
              document.getElementById('createFirstDeckBtn').addEventListener('click', showCreateDeckModal);
              return;
            }

            decksContainer.innerHTML = ''; 
            
            // Add "Create New Deck" button at the top
            const createDeckElement = document.createElement('div');
            createDeckElement.className = 'result-item';
            createDeckElement.innerHTML = `
              <button id="createNewDeckBtn" class="view-deck-btn" style="margin-bottom: 20px;">
                + Create New Deck
              </button>
              <hr>
            `;
            decksContainer.appendChild(createDeckElement);
            document.getElementById('createNewDeckBtn').addEventListener('click', showCreateDeckModal);
            
            // Add existing decks
            decks.forEach(deck => {
              const deckElement = document.createElement('div');
              deckElement.className = 'result-item';
              deckElement.innerHTML = `
                <h3>${deck.name}</h3>
                <div class="deck-actions">
                  <button class="view-deck-btn" data-deck-id="${deck.id}">
                    View Deck
                  </button>
                  <button class="study-deck-btn" data-deck-id="${deck.id}">
                    Study Deck
                  </button>
                  <button class="delete-deck-btn" data-deck-id="${deck.id}">
                    Delete Deck
                  </button>
                </div>
                <hr>
              `;
              decksContainer.appendChild(deckElement);
            });

            // Add event listeners to all deck buttons
            document.querySelectorAll('.view-deck-btn').forEach(button => {
              if (button.id !== 'createNewDeckBtn' && button.id !== 'createFirstDeckBtn') {
                button.addEventListener('click', function() {
                  window.location.href = `/deck/${this.dataset.deckId}`;
                });
              }
            });

            document.querySelectorAll('.study-deck-btn').forEach(button => {
              button.addEventListener('click', function() {
                window.location.href = `/deck/${this.dataset.deckId}/study`;
              });
            });

            document.querySelectorAll('.delete-deck-btn').forEach(button => {
              button.addEventListener('click', async function() {
                const deckId = this.dataset.deckId;
                if (confirm('Are you sure you want to delete this deck?')) {
                  try {
                    const response = await fetch(`/api/decks/${deckId}`, {
                      method: 'DELETE',
                      headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();
                    if (!response.ok) {
                      alert(result.message || 'Failed to delete deck');
                      return;
                    }
                    fetchDecks(); // Refresh the list after deletion
                  } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting deck');
                  }
                }
              });
            });
          })
          .catch(error => {
            console.error('Error:', error);
            decksContainer.innerHTML = `
              <div class="result-item error">
                <p>${error.message}</p>
                ${error.message.includes('expired') 
                  ? '<a href="/auth/login" class="login-link">Login Page</a>' 
                  : '<button onclick="fetchDecks()">Retry</button>'}
              </div>
            `;
          });
      }

      // Initial fetch of decks
      fetchDecks();
    });
  </script>

{% endblock %}