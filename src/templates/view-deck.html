{% extends "base.html" %}

{% block content %}

  <div class="deck-view">

    <h2 id="deckName"></h2>
    <div id="deckWords"></div>
    {% if logged_in %}
    <p style="padding: 1rem;">
    <br>
    <a href="/decks" class="btn">Back to all decks</a>
    </p>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const deckId = {{ deck_id }};
      
      // Main function to fetch and display words
      function fetchWords() {
        fetch(`/api/decks/${deckId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error('Failed to fetch deck');
            }
            return response.json();
          })
          .then((deck) => {
            // Update deck name
            document.getElementById('deckName').textContent = deck.name || 'Unnamed Deck';
            
            const container = document.getElementById('deckWords');
            container.innerHTML = '';

            // Handle empty deck
            if (!deck.words || deck.words.length === 0) {
              container.innerHTML = '<p>This deck has no words yet.</p>';
              return;
            }

            // Create words container
            const wordsContainer = document.createElement('div');
            wordsContainer.className = 'words-container';

            // Add each word to the container
            deck.words.forEach((word) => {
              const wordItem = document.createElement('div');
              wordItem.className = 'word-item';
              
              wordItem.innerHTML = `
                <div class="characters">
                  <div><strong>Simplified: </strong><span class="simplified">${word.hanzi || word.simplified || ''}</span></div>
                  ${word.traditional && word.traditional !== word.hanzi ? 
                    `<div><strong>Traditional: </strong><span class="traditional">${word.traditional}</span></div>` : ''}
                </div>
                <div class="pinyin"><br><strong>Pinyin: </strong>${word.pinyin || ''}</div>
                <br>
                <div class="definitions">
                  <strong>Definition: </strong>
                  ${
                    word.definition
                      ? `<ul>${
                          word.definition
                            .split(', ')
                            .map((def) => `<li>${def}</li>`)
                            .join('')
                        }</ul>`
                      : 'No definition available'
                  }
                </div>
                <button class="delete-word-btn" data-word-id="${word.id}">
                  Delete Word
                </button>
                <hr>
              `;

              wordsContainer.appendChild(wordItem);
            });

            container.appendChild(wordsContainer);
            
            // Attach event listeners to all delete buttons
            document.querySelectorAll('.delete-word-btn').forEach(button => {
              button.addEventListener('click', handleDeleteWord);
            });
          })
          .catch((error) => {
            console.error('Error:', error);
            document.getElementById('deckWords').innerHTML = `
              <div class="error">
                <p>Error loading deck: ${error.message}</p>
                <button onclick="fetchWords()" class="btn">Retry</button>
              </div>
            `;
          });
      }

      // Handle word deletion
      async function handleDeleteWord(event) {
        const wordId = event.target.dataset.wordId;
        
        if (confirm('Are you sure you want to delete this word from this deck?')) {
          try {
            const response = await fetch(`/api/decks/${deckId}/${wordId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Failed to delete word');
            }

            // Refresh the word list after successful deletion
            fetchWords();
          } catch (error) {
            console.error('Deletion error:', error);
            alert(`Error: ${error.message}`);
          }
        }
      }

      // Initial load
      fetchWords();
    });
  </script>

{% endblock %}